<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <title>Where'd all this shit come from??</title>
    <link rel="stylesheet" href="reset.css" type="text/css" media="all" charset="utf-8" />
    <link rel="stylesheet" href="style.css" type="text/css" media="all" charset="utf-8" />
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="script.js" type="text/javascript" charset="utf-8"></script>
         <script type="text/javascript" src="https://www.google.com/jsapi?key=ABQIAAAAmyDp7lZZjI3edkPRVK2YohRk2KHBNoZ1Mgd5BZUaYFpZVj4FDxT5DjxszrcAh8kpG73PMx2Iuw5Y2w"></script>
        <script type="text/javascript" src="http://maps.google.com/maps/api/js?v=3.4&sensor=true&"></script>
        <script type="text/javascript" src='http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.2/jquery-ui.min.js'></script>
        <script type="text/javascript">
          var geocoder;
          var map;
          var current_latitude;
          var current_longitude;
          var found_current_location=false;

          function initialize() {
            getGeoLocation();
            geocoder = new google.maps.Geocoder();
            // default lat long
            var latlng = new google.maps.LatLng(40.713, -73.938);
            var myOptions = {
              zoom: 11,
              center: latlng,
              mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
            if (found_current_location){
              queryCartoDBforCSO(current_latitude,current_longitude);
              load_weather(current_latitude, current_longitude);
            }
          };

          function getGeoLocation() {
            if (google.loader.ClientLocation) {
              current_latitude=google.loader.ClientLocation.latitude;
              current_longitude=google.loader.ClientLocation.longitude;
              found_current_location=true;
            };
            return found_current_location;
            //latlng = new google.maps.LatLng(google.loader.ClientLocation.latitude, google.loader.ClientLocation.longitude);
          };

          function load_weather(latitude, longitude) {
            if (found_current_location) {

              var url = "http://api.wunderground.com/weather/api/308f3fab4eab7071/geolookup/conditions/q/"+(latitude)+","+(longitude)+".json?callback=?";
              //alert(url);

              $.getJSON(url, {format: "json"}, function(data) {
                //alert(":"+ data.current_observation.precip_today_in);
                $('#rain_inches').replaceWith('<span id="rain_inches">' +  data.current_observation.precip_today_in + '</span>');

                var rainInches = data.current_observation.precip_today_in;
                var rainHourInches = data.current_observation.precip_1hr_in;
                if (rainInches > .40 || rainHourInches > .10) {
                  alert("Don't Flush Yet!");
                  document.getElementById("flushAlertText").value="Don't Flush Right Now!!";  //TODO: get the specific element to change text on
                };
              });
            } else {
              alert("I'm sorry, but geolocation services are not supported by your browser or you do not have a GPS device in your computer.");
            };
          };

          function geoCodeAddress(){
            var latitude=0;
            var longitude=0;
            var address=$('#user_address').val();
            geocoder.geocode( { 'address': address}, function(results, status) {
              if (status == google.maps.GeocoderStatus.OK) {
                latitude=results[0].geometry.location.lat();
                longitude=results[0].geometry.location.lng();
                queryCartoDBforCSO(latitude,longitude);
                load_weather(latitude, longitude);
              } else {
                alert("Geocode was not successful for the following reason: " + status);
              }
            });
           };

          function queryCartoDBforCSO(latitude, longitude){
            query="SELECT DISTINCT(sheds.drainage_n), ST_AsGeoJSON(pol.the_geom) as polygon, ST_AsGeoJSON(poin.the_geom) as point_geom FROM drain_areas_wgs84webmerc_nodupou as pol inner join cso_nyc_wgs84webmerc_latlon as poin on poin.item_id=pol.primary_ou, drainage_nyc_sewage_plant_sheds as sheds WHERE ST_Intersects(pol.the_geom,ST_GeomFromText('POINT(" + longitude + " " + latitude + ")',4326)) AND (sheds.wpcp=poin.wpcp OR sheds.alt_name=poin.wpcp)";
            req='http://ecohack-nyc-03.cartodb.com/api/v1/sql?callback=?&q=' + escape(query);
            //$('#query').replaceWith('<div id="query">' + req + '</div>');
            $.getJSON(req, function(data) {

              options = { "strokeColor": "#FF7800","strokeOpacity": 1,"strokeWeight": 2,
                    "fillColor": "#46461F","fillOpacity": 0.25 ,
                    "icon" : 'http://dontflush.me/icons/csoIcon.png'};

              if (data['rows'][0]) {

                eval("geoparsed="+data['rows'][0]['point_geom']);
                var myCSO = new GeoJSON(geoparsed, options);
                if (myCSO.error){
                    alert('something broke');
                }else{
                    myCSO.setMap(map);
                };

                eval("geoparsed="+data['rows'][0]['polygon']);
                var myGoogleVector = new GeoJSON(geoparsed, options);
                if (myGoogleVector.error){
                    alert('something broke');
                }else{
                   mylatlong=new google.maps.LatLng(latitude,longitude);
                   marker = new google.maps.Marker({
                        map: map,
                        position: mylatlong
                    });
                    myGoogleVector[0].setMap(map);
                    map.setCenter(mylatlong);
                    map.setZoom(14);
                };

              } else {
                alert('your address is not in our database');
              };
            });
          };

        </script>
        <script language="javascript">
    var GeoJSON = function( geojson, options ){

      var _geometryToGoogleMaps = function( geojsonGeometry, opts, geojsonProperties ){

        var googleObj;

        switch ( geojsonGeometry.type ){
          case "Point":
            opts.position = new google.maps.LatLng(geojsonGeometry.coordinates[1], geojsonGeometry.coordinates[0]);
            googleObj = new google.maps.Marker(opts);
            if (geojsonProperties) {
              googleObj.set("geojsonProperties", geojsonProperties);
            }
            break;

          case "MultiPoint":
            googleObj = [];
            for (var i = 0; i < geojsonGeometry.coordinates.length; i++){
              opts.position = new google.maps.LatLng(geojsonGeometry.coordinates[i][1], geojsonGeometry.coordinates[i][0]);
              googleObj.push(new google.maps.Marker(opts));
            }
            if (geojsonProperties) {
              for (var k = 0; k < googleObj.length; k++){
                googleObj[k].set("geojsonProperties", geojsonProperties);
              }
            }
            break;

          case "LineString":
            var path = [];
            for (var i = 0; i < geojsonGeometry.coordinates.length; i++){
              var coord = geojsonGeometry.coordinates[i];
              var ll = new google.maps.LatLng(coord[1], coord[0]);
              path.push(ll);
            }
            opts.path = path;
            googleObj = new google.maps.Polyline(opts);
            if (geojsonProperties) {
              googleObj.set("geojsonProperties", geojsonProperties);
            }
            break;

          case "MultiLineString":
            googleObj = [];
            for (var i = 0; i < geojsonGeometry.coordinates.length; i++){
              var path = [];
              for (var j = 0; j < geojsonGeometry.coordinates[i].length; j++){
                var coord = geojsonGeometry.coordinates[i][j];
                var ll = new google.maps.LatLng(coord[1], coord[0]);
                path.push(ll);
              }
              opts.path = path;
              googleObj.push(new google.maps.Polyline(opts));
            }
            if (geojsonProperties) {
              for (var k = 0; k < googleObj.length; k++){
                googleObj[k].set("geojsonProperties", geojsonProperties);
              }
            }
            break;

          case "Polygon":
            var paths = [];
            for (var i = 0; i < geojsonGeometry.coordinates.length; i++){
              var path = [];
              for (var j = 0; j < geojsonGeometry.coordinates[i].length; j++){
                var ll = new google.maps.LatLng(geojsonGeometry.coordinates[i][j][1], geojsonGeometry.coordinates[i][j][0]);
                path.push(ll)
              }
              paths.push(path);
            }
            opts.paths = paths;
            googleObj = new google.maps.Polygon(opts);
            if (geojsonProperties) {
              googleObj.set("geojsonProperties", geojsonProperties);
            }
            break;

          case "MultiPolygon":
            googleObj = [];
            for (var i = 0; i < geojsonGeometry.coordinates.length; i++){
              var paths = [];
              for (var j = 0; j < geojsonGeometry.coordinates[i].length; j++){
                var path = [];
                for (var k = 0; k < geojsonGeometry.coordinates[i][j].length; k++){
                  var ll = new google.maps.LatLng(geojsonGeometry.coordinates[i][j][k][1], geojsonGeometry.coordinates[i][j][k][0]);
                  path.push(ll);
                }
                paths.push(path);
              }
              opts.paths = paths;
              googleObj.push(new google.maps.Polygon(opts));
            }
            if (geojsonProperties) {
              for (var k = 0; k < googleObj.length; k++){
                googleObj[k].set("geojsonProperties", geojsonProperties);
              }
            }
            break;

          case "GeometryCollection":
            googleObj = [];
            if (!geojsonGeometry.geometries){
              googleObj = _error("Invalid GeoJSON object: GeometryCollection object missing \"geometries\" member.");
            }else{
              for (var i = 0; i < geojsonGeometry.geometries.length; i++){
                googleObj.push(_geometryToGoogleMaps(geojsonGeometry.geometries[i], opts, geojsonProperties || null));
              }
            }
            break;

          default:
            googleObj = _error("Invalid GeoJSON object: Geometry object must be one of \"Point\", \"LineString\", \"Polygon\" or \"MultiPolygon\".");
        }

        return googleObj;

      };

      var _error = function( message ){

        return {
          type: "Error",
          message: message
        };

      };

      var obj;

      var opts = options || {};

      switch ( geojson.type ){

        case "FeatureCollection":
          if (!geojson.features){
            obj = _error("Invalid GeoJSON object: FeatureCollection object missing \"features\" member.");
          }else{
            obj = [];
            for (var i = 0; i < geojson.features.length; i++){
              obj.push(_geometryToGoogleMaps(geojson.features[i].geometry, opts, geojson.features[i].properties));
            }
          }
          break;

        case "GeometryCollection":
          if (!geojson.geometries){
            obj = _error("Invalid GeoJSON object: GeometryCollection object missing \"geometries\" member.");
          }else{
            obj = [];
            for (var i = 0; i < geojson.geometries.length; i++){
              obj.push(_geometryToGoogleMaps(geojson.geometries[i], opts));
            }
          }
          break;

        case "Feature":
          if (!( geojson.properties && geojson.geometry )){
            obj = _error("Invalid GeoJSON object: Feature object missing \"properties\" or \"geometry\" member.");
          }else{
            obj = _geometryToGoogleMaps(geojson.geometry, opts, geojson.properties);
          }
          break;

        case "Point": case "MultiPoint": case "LineString": case "MultiLineString": case "Polygon": case "MultiPolygon":
          obj = geojson.coordinates
            ? obj = _geometryToGoogleMaps(geojson, opts)
            : _error("Invalid GeoJSON object: Geometry object missing \"coordinates\" member.");
          break;

        default:
          obj = _error("Invalid GeoJSON object: GeoJSON object must be one of \"Point\", \"LineString\", \"Polygon\", \"MultiPolygon\", \"Feature\", \"FeatureCollection\" or \"GeometryCollection\".");

      }

      return obj;

    };
    </script>
    <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-23714683-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
      </head>
      <body onload="initialize()" class="one-sidebar sidebar-first ltr">
      <div class="container-full clearfix">
      <div class="header clearfix">
        <h1>DontFlush.Me</h1>
      </div>
      <div class="sidebar-first"><div class="sidebar-inner">
        <div class="container">
          <p>Unprocessed sewage overflows into NYC waterways as often as once a week.</p>
          <p>27 billion gallons of untreated sewage is dumped into NYC's Harbor every year.</p>
          <p>Combined Sewer Overflows (CSOs) happen when the sewer system is overloaded by rainfall and snow.</p>
          <p>Help keep your shit out of the harbor during storms.</p>
        </div>

        <div class="container red">
          <p>Enter your address to see if you currently are in a no-flush zone.</p>
          <form id="the-form" action="/" method="post" accept-charset="utf-8">
          <input class="text" id="user_address" name="user_address">
            <input type="submit" value="Submit" class="submit" />
          </form>
        </div>

        <div class="container gray tips">

          <div class="tip">
            <h2 class="tip-heading">Tip</h2>
            <p>A low-flow toilet could save 50-80 gallons of water a day.</p>
          </div>
          <div class="tip">
            <h2 class="tip-heading">Fact</h2>
            <p>NYC has 14 sewage treatment plants.  </p>
          </div>
          <div class="tip">
            <h2 class="tip-heading">Tip</h2>
            <p>Fill a liter bottle with water and add it to your toilet's tank to displace some volume.</p>
          </div>
          <div class="tip">
            <h2 class="tip-heading">Fact</h2>
            <p>70% of NYC sewage systems collect storm water runoff, domestic sewage, and industrial wastewater in the same pipe.  </p>
          </div>
          <div class="tip">
            <h2 class="tip-heading">Tip</h2>
            <p>Postpone your laundry for a day</p>
          </div>
          <div class="tip">
            <h2 class="tip-heading">Fact</h2>
            <p>A rainfall of 1/10" in an hour or 4/10" inch in 24 hours can overwhelm the system and result in release of untreated sewage to NYC waterways.</p>
          </div>
          <div class="tip">
            <h2 class="tip-heading">Tip</h2>
            <p>Take a shorter shower on rainy days</p>
          </div>
          <div class="tip">
            <h2 class="tip-heading">Fact</h2>
            <p>Release of untreated sewage occurs at 460 sites around NYC called Combined Sewer Outflow (CSO).</p>
          </div>
          <div class="tip">
            <h2 class="tip-heading">Tip</h2>
            <p>Don't throw trash into the toilet - it gets discharged too!</p>
          </div>
          <div class="tip">
            <h2 class="tip-heading">Fact</h2>
            <p>27 billion gallons of untreated wastewater are released into NYC waterways every year.</p>
          </div>
          <div class="tip">
            <h2 class="tip-heading">Tip</h2>
            <p>Leave the dishes in the sink</p>
          </div>
          <div class="tip">
            <h2 class="tip-heading">Fact</h2>
            <p>Average NYC flush is 5 gallons (1 less flush a day = 40 million gallons saved)</p>
          </div>
        </div>


      </div></div>
      <div class="main">
        <div class="alert">
        There have been <span id="rain_inches"></span> inches of rain today in your area.
        </div>
        <div id="map_canvas" style="width: 644px; height: 495px; display:inline-block;"></div>
      </div>

    </div>
    <div class="footer clearfix">
      Thanks to Matt, Eric, Jeni, Liz, Jeff, Chris, Sheiva, Anna, Karen, Wendy and Carl For making this site happen! Thanks to Javier at <a href="http://vizzuality.com/">Vizzuality</a> for making CartoDB available! Copyright &copy; 2011
    </div>
  </body>
</html>
